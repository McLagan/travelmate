<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdnjs.cloudflare.com https://fonts.googleapis.com; connect-src 'self'; style-src 'self' 'unsafe-inline' https://unpkg.com https://cdnjs.cloudflare.com https://fonts.googleapis.com; object-src 'none';">
    <meta name="robots" content="noindex, nofollow">
    <title>TravelMate - Smart Route Planning</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Application Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="#" class="nav-brand">
                <i class="fas fa-route"></i>
                TravelMate
            </a>

            <ul class="nav-menu">
                <li><a href="#" class="nav-link">Features</a></li>
                <li><a href="#" class="nav-link">About</a></li>
                <li><a href="#" class="nav-link">Contact</a></li>
            </ul>

            <div class="nav-actions">
                <button class="btn btn-outline btn-sm" onclick="showAuthModal('login')" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In
                </button>
                <button class="btn btn-primary btn-sm" onclick="showAuthModal('register')" id="registerBtn">
                    <i class="fas fa-user-plus"></i>
                    Sign Up
                </button>

                <!-- User Menu (hidden by default) -->
                <div class="user-menu" id="userMenu" style="display: none; align-items: center; gap: 1rem;">
                    <span id="userName" style="font-weight: 500;"></span>
                    <button class="btn btn-primary btn-sm" onclick="goToProfile()">
                        <i class="fas fa-user"></i>
                        Profile
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>

            <button class="control-btn" onclick="toggleSidebar()" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-route"></i> Route Planner</h2>
                <p class="text-muted">Plan your perfect journey</p>
            </div>

            <div class="sidebar-content">
                <!-- Guest Banner -->
                <div class="guest-banner" id="guestBanner">
                    <h3><i class="fas fa-lock"></i> Sign in to continue</h3>
                    <p>Create an account to save routes and access premium features</p>
                    <button class="btn btn-outline" onclick="showAuthModal('login')" style="margin-top: 0.5rem; border-color: rgba(255,255,255,0.3); color: white;">
                        Get Started
                    </button>
                </div>

                <!-- Location Section -->
                <div class="section">
                    <h3 class="section-title">
                        <i class="fas fa-location-arrow"></i>
                        My Location
                    </h3>
                    <button class="btn btn-secondary" onclick="getCurrentLocation()" style="width: 100%;" disabled>
                        <i class="fas fa-crosshairs"></i>
                        Use Current Location
                    </button>
                </div>

                <!-- Search Section -->
                <div class="section">
                    <h3 class="section-title">
                        <i class="fas fa-search"></i>
                        Search Places
                    </h3>
                    <div class="form-group">
                        <input type="text" class="form-input" id="searchInput" placeholder="Search for places, addresses..." disabled>
                        <button class="btn btn-primary" onclick="searchPlace()" style="margin-top: 0.5rem; width: 100%;" disabled>
                            <i class="fas fa-search"></i>
                            Search
                        </button>
                    </div>
                </div>

                <!-- Route Planning Section -->
                <div class="section">
                    <h3 class="section-title">
                        <i class="fas fa-map-marked-alt"></i>
                        Route Planning
                    </h3>

                    <div class="form-group">
                        <label class="form-label">Transportation Mode</label>
                        <select class="form-select" id="transportMode" disabled>
                            <option value="driving">🚗 Driving</option>
                            <option value="walking">🚶 Walking</option>
                            <option value="cycling">🚴 Cycling</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <p style="color: var(--text-muted); font-size: 0.875rem; text-align: center; padding: 1rem; border: 1px dashed var(--border-color); border-radius: var(--radius-md);">
                            <i class="fas fa-mouse-pointer"></i><br>
                            Click on the map to add points, then choose "Set as Start" or "Set as End"
                        </p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Route Name</label>
                        <input type="text" class="form-input" id="routeName" placeholder="Enter route name..." disabled>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description (Optional)</label>
                        <input type="text" class="form-input" id="routeDescription" placeholder="Add route description..." disabled>
                    </div>

                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="calculateRealRoute()" id="realRouteBtn" disabled style="flex: 1;">
                            <i class="fas fa-route"></i>
                            Calculate Route
                        </button>
                        <button class="btn btn-primary" onclick="createRoute()" id="createRouteBtn" disabled style="flex: 1;">
                            <i class="fas fa-save"></i>
                            Save Route
                        </button>
                    </div>

                    <button class="btn btn-secondary" onclick="loadRoutes()" style="width: 100%; margin-top: 0.5rem;" disabled>
                        <i class="fas fa-list"></i>
                        My Routes
                    </button>
                </div>

                <!-- Routes List -->
                <div class="section">
                    <div id="routesList" style="display: none;"></div>
                </div>
            </div>
        </aside>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>

            <!-- Map Controls -->
            <div class="map-controls">
                <button class="control-btn" onclick="clearMap()" title="Clear all markers">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button class="control-btn" onclick="centerMap()" title="Center map">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button class="control-btn" onclick="getCurrentLocation()" title="My location" disabled>
                    <i class="fas fa-location-arrow"></i>
                </button>
                <button class="control-btn" onclick="toggleAddPlaceMode()" title="Add place mode" id="addPlaceModeBtn" disabled>
                    <i class="fas fa-map-pin"></i>
                </button>
            </div>

            <!-- Status Message -->
            <div class="status-message" id="statusMessage"></div>

            <!-- Map Context Menu -->
            <div class="map-context-menu" id="mapContextMenu" style="display: none;">
                <div class="context-menu-item" onclick="setAsStartPoint()">
                    <i class="fas fa-play"></i>
                    Set as Start Point
                </div>
                <div class="context-menu-item" onclick="setAsEndPoint()">
                    <i class="fas fa-stop"></i>
                    Set as End Point
                </div>
                <div class="context-menu-item" onclick="addPlaceHere()" id="addPlaceContextItem" style="display: none;">
                    <i class="fas fa-plus"></i>
                    Add Place Here
                </div>
            </div>
        </div>
    </main>

    <!-- Authentication Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="authTitle">Welcome Back</h3>
                <p class="modal-subtitle" id="authSubtitle">Sign in to your account</p>
            </div>
            <div class="modal-body">
                <!-- Login Form -->
                <form class="auth-form" id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i>
                        Sign In
                    </button>
                </form>

                <!-- Register Form -->
                <form class="auth-form" id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="registerName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="registerEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="registerPassword" placeholder="Create a password (min 6 characters)" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-user-plus"></i>
                        Create Account
                    </button>
                </form>

                <div class="auth-toggle">
                    <p id="authToggleText">
                        Don't have an account?
                        <button type="button" onclick="toggleAuthMode()" id="authToggleBtn">Sign up</button>
                    </p>
                </div>

                <button class="btn btn-secondary" onclick="closeAuthModal()" style="width: 100%; margin-top: 1rem;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Add Place Modal -->
    <div class="modal-overlay" id="quickAddPlaceModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3 class="modal-title">Add Place</h3>
                <p class="modal-subtitle">Add this location to your places</p>
            </div>
            <div class="modal-body">
                <form id="quickAddPlaceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Place Name *</label>
                            <input type="text" class="form-input" id="quickPlaceName" placeholder="Enter place name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="quickPlaceCategory">
                                <option value="attraction">🏛️ Attraction</option>
                                <option value="restaurant">🍽️ Restaurant</option>
                                <option value="hotel">🏨 Hotel</option>
                                <option value="nature">🌲 Nature</option>
                                <option value="beach">🏖️ Beach</option>
                                <option value="museum">🏛️ Museum</option>
                                <option value="shopping">🛍️ Shopping</option>
                                <option value="entertainment">🎭 Entertainment</option>
                                <option value="transport">🚌 Transport</option>
                                <option value="other">📍 Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="quickPlaceDescription" rows="3" placeholder="Describe this place..."></textarea>
                    </div>

                    <!-- Photo Upload Section -->
                    <div class="form-group">
                        <label class="form-label">Photo</label>
                        <div class="photo-upload-container">
                            <input type="file" id="quickPlacePhoto" accept="image/*" class="file-input" style="display: none;">
                            <div class="photo-upload-area" onclick="document.getElementById('quickPlacePhoto').click()">
                                <div class="photo-preview" id="photoPreview" style="display: none;">
                                    <img id="previewImage" src="" alt="Preview">
                                    <div class="photo-controls">
                                        <button type="button" class="btn-icon" onclick="removePhoto()" title="Remove photo">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="photo-upload-placeholder" id="uploadPlaceholder">
                                    <i class="fas fa-camera"></i>
                                    <p>Click to upload photo</p>
                                    <small>JPG, PNG, GIF up to 5MB</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Official Website -->
                    <div class="form-group">
                        <label class="form-label">Official Website/Source</label>
                        <input type="url" class="form-input" id="quickPlaceWebsite" placeholder="https://example.com">
                    </div>

                    <!-- Custom Fields Section -->
                    <div class="form-group">
                        <div class="custom-fields-header">
                            <label class="form-label">Custom Fields</label>
                            <button type="button" class="btn-toggle" onclick="toggleCustomFields()" id="customFieldsToggle">
                                <i class="fas fa-plus"></i>
                                Add Custom Field
                            </button>
                        </div>
                        <div class="custom-fields-container" id="customFieldsContainer" style="display: none;">
                            <div class="custom-fields-list" id="customFieldsList"></div>
                            <button type="button" class="btn btn-outline btn-sm" onclick="addCustomField()" style="margin-top: 0.5rem;">
                                <i class="fas fa-plus"></i>
                                Add Another Field
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <small class="form-text">
                            <i class="fas fa-map-marker-alt"></i>
                            Coordinates: <span id="quickPlaceCoords"></span>
                        </small>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-plus"></i>
                            Add Place
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeQuickAddPlaceModal()" style="flex: 1;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Extension Blocker (must be first) -->
    <script src="extension-blocker.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Application Scripts -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="navigation.js"></script>
    <script src="app.js"></script>
    <script src="features.js"></script>
    <script src="map-places.js"></script>

    <!-- Enhanced Control Management -->
    <script>
        // Enhanced control management for location features
        document.addEventListener('DOMContentLoaded', function() {
            // Enable location button for all users
            const locationButtons = document.querySelectorAll('[onclick*="getCurrentLocation"]');
            locationButtons.forEach(btn => {
                btn.disabled = false;
            });

            // Add enhanced enable/disable controls
            window.enableLocationControls = function() {
                locationButtons.forEach(btn => btn.disabled = false);

                const searchBtn = document.querySelector('[onclick="searchPlace()"]');
                if (searchBtn) searchBtn.disabled = false;
            };

            window.disableLocationControls = function() {
                // Location is always available
                const searchBtn = document.querySelector('[onclick="searchPlace()"]');
                if (searchBtn) searchBtn.disabled = true;
            };

            // Override app control functions
            const originalEnableControls = window.app?.enableControls;
            if (originalEnableControls) {
                window.app.enableControls = function() {
                    originalEnableControls.call(this);
                    enableLocationControls();
                };
            }

            const originalDisableControls = window.app?.disableControls;
            if (originalDisableControls) {
                window.app.disableControls = function() {
                    originalDisableControls.call(this);
                    disableLocationControls();
                };
            }
        });
    </script>
</body>
</html>